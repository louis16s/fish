<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fish 日志</title>
  <style>
    :root{
      --bg0:#070a13;
      --bg1:#0b1630;
      --stroke:rgba(148,163,184,.22);
      --stroke2:rgba(148,163,184,.32);
      --text:#e7eefc;
      --muted:#a5b4cf;
      --muted2:#7c8db4;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#fb7185;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:18px;
      --font:"Bahnschrift","Segoe UI Variable Display","Segoe UI","PingFang SC","Microsoft YaHei UI",system-ui,-apple-system,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% 12%, rgba(34,211,238,.25), transparent 55%),
        radial-gradient(900px 700px at 85% 18%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(1100px 900px at 70% 88%, rgba(59,130,246,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding:18px 14px 28px;
      overflow-x:hidden;
    }
    .wrap{max-width:1180px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .statusDot{
      width:12px;height:12px;border-radius:999px;
      background:rgba(148,163,184,.55);
      box-shadow:0 0 0 6px rgba(148,163,184,.08);
      flex:0 0 auto;
    }
    .statusDot.on{background:var(--good);box-shadow:0 0 0 6px rgba(34,197,94,.15), 0 0 26px rgba(34,197,94,.20)}
    .statusDot.bad{background:var(--bad);box-shadow:0 0 0 6px rgba(251,113,133,.12), 0 0 26px rgba(251,113,133,.20)}
    .brandTxt{min-width:0}
    .brandTitle{
      font-weight:950;letter-spacing:.3px;
      font-size:15px;line-height:1.15;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brandSub{
      font-size:12px;color:var(--muted);
      margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-family:var(--mono);
    }
    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .navbtn{
      display:inline-grid;place-items:center;
      min-height:44px;padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      text-decoration:none;
      color:var(--text);
      background:rgba(255,255,255,.04);
      font-weight:900;
      transition:background .18s ease,border-color .18s ease,transform .06s ease;
    }
    .navbtn:hover{background:rgba(255,255,255,.08);border-color:var(--stroke2)}
    .navbtn:active{transform:translateY(1px)}

    .panel{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panelHd{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(148,163,184,.16);
    }
    .panelTitle{font-weight:950;letter-spacing:.25px}
    .panelSub{margin-top:3px;color:var(--muted2);font-size:12px;line-height:1.55}
    .panelBody{padding:14px}

    .segs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .seg{
      appearance:none;
      min-height:40px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:950;
      cursor:pointer;
      transition:background .18s ease,border-color .18s ease,transform .06s ease;
    }
    .seg:hover{background:rgba(255,255,255,.08);border-color:rgba(148,163,184,.32)}
    .seg:active{transform:translateY(1px)}
    .seg.on{border-color:rgba(34,211,238,.34);background:rgba(34,211,238,.14);color:var(--text)}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-bottom:12px}
    .btn{
      appearance:none;
      min-height:48px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-weight:980;
      cursor:pointer;
      transition:background .18s ease,border-color .18s ease,transform .06s ease;
    }
    .btn:hover{background:rgba(255,255,255,.08);border-color:rgba(148,163,184,.32)}
    .btn:active{transform:translateY(1px)}
    .btn.danger{border-color:rgba(251,113,133,.35);background:linear-gradient(180deg, rgba(251,113,133,.18), rgba(2,6,23,.02))}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    pre.logPre{
      margin:0;
      border:1px solid rgba(148,163,184,.18);
      border-radius:14px;
      background:rgba(2,6,23,.55);
      color:#e2e8f0;
      padding:12px;
      min-height:520px;
      max-height:70vh;
      overflow:auto;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.55;
      box-shadow:0 10px 24px rgba(0,0,0,.25) inset;
    }
    .hint{margin-top:10px;color:var(--muted2);font-size:12px;line-height:1.6}

    :focus-visible{outline:3px solid rgba(56,189,248,.65);outline-offset:2px;border-radius:12px}
    @media (max-width:520px){
      .nav{gap:8px}
      .actions{justify-content:stretch}
      .actions .btn{flex:1}
    }
    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important;transition:none !important;animation:none !important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <span class="statusDot" id="statusDot" aria-hidden="true"></span>
        <div class="brandTxt">
          <div class="brandTitle">日志</div>
          <div class="brandSub" id="verLine">UI --</div>
        </div>
      </div>
      <nav class="nav" aria-label="快捷入口">
        <a class="navbtn" href="/update">升级</a>
        <a class="navbtn" href="/">面板</a>
        <a class="navbtn" href="/config">配置</a>
      </nav>
    </header>

    <section class="panel">
      <div class="panelHd">
        <div>
          <div class="panelTitle">日志查看</div>
          <div class="panelSub">默认读取末尾 16KB（LittleFS）。</div>
        </div>
        <div class="segs" role="tablist" aria-label="日志类型">
          <button class="seg on" id="t_error" role="tab" aria-selected="true" onclick="setTab('error')">错误</button>
          <button class="seg" id="t_measure" role="tab" aria-selected="false" onclick="setTab('measure')">测量</button>
          <button class="seg" id="t_action" role="tab" aria-selected="false" onclick="setTab('action')">动作</button>
        </div>
      </div>
      <div class="panelBody">
        <div class="actions">
          <button class="btn" id="btnRefresh" onclick="refresh()">刷新</button>
          <button class="btn danger" id="btnClear" onclick="clearCur()">清空当前日志</button>
        </div>
        <pre id="logBox" class="logPre">加载中…</pre>
        <div class="hint" id="msg"></div>
      </div>
    </section>
  </div>

  <script>
    const UI_VERSION = 'ui-2026.02.13-01';
    let cur = 'error';
    const $ = (id) => document.getElementById(id);

    function setDot(state){
      const el = $('statusDot');
      el.className = 'statusDot' + (state === 'on' ? ' on' : (state === 'bad' ? ' bad' : ''));
    }

    async function fetchTelemetry(){
      try{
        const r = await fetch('/api/state', {cache:'no-store'});
        const j = await r.json();
        if(!r.ok) throw new Error('HTTP ' + r.status);
        return j.telemetry || j;
      }catch(e){
        const r2 = await fetch('/getData', {cache:'no-store'});
        const j2 = await r2.json();
        if(!r2.ok) throw new Error('HTTP ' + r2.status);
        return j2;
      }
    }

    async function loadVersionLine(){
      try{
        const t = await fetchTelemetry();
        const fw = (t.fw && t.fw.current) ? t.fw.current : ((typeof t.fw === 'string') ? t.fw : (t.fw_version || t.fwVersion || t.version || '--'));
        $('verLine').textContent = (fw && fw !== '--') ? ('固件版本 ' + fw + ' | UI ' + UI_VERSION) : ('UI ' + UI_VERSION);
      }catch(e){
        $('verLine').textContent = 'UI ' + UI_VERSION;
      }
    }

    function setTab(t){
      cur = t;
      ['error','measure','action'].forEach(k=>{
        const el = $('t_'+k);
        const on = (k === t);
        el.className = on ? 'seg on' : 'seg';
        el.setAttribute('aria-selected', on ? 'true' : 'false');
      });
      refresh();
    }

    async function refresh(){
      try{
        const r = await fetch('/api/log?name=' + encodeURIComponent(cur) + '&tail=16384', {cache:'no-store'});
        const tx = await r.text();
        $('logBox').textContent = tx.length ? tx : '(空)';
        if(!r.ok){
          $('msg').textContent = (r.status === 401) ? '读取失败：未授权（需要面板密码）' : ('读取失败：HTTP ' + r.status + ' ' + tx);
          setDot('bad');
        }else{
          $('msg').textContent = '';
          setDot('on');
        }
        $('logBox').scrollTop = $('logBox').scrollHeight;
      }catch(e){
        $('msg').textContent = '读取失败：网络错误';
        setDot('bad');
      }
    }

    async function clearCur(){
      if(!confirm('确认清空当前日志？')) return;
      try{
        const r = await fetch('/api/log/clear', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:cur})});
        const tx = await r.text();
        $('msg').textContent = r.ok ? '已清空' : ((r.status === 401) ? '清空失败：未授权（需要面板密码）' : ('清空失败：HTTP ' + r.status + ' ' + tx));
      }catch(e){
        $('msg').textContent = '清空失败：网络错误';
      }
      refresh();
    }

    window.setTab = setTab;
    window.refresh = refresh;
    window.clearCur = clearCur;

    loadVersionLine();
    setInterval(refresh, 2000);
    refresh();
  </script>
</body>
</html>
