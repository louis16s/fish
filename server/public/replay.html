<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/ui/favicon.svg?v=ui-2026.02.15-01" type="image/svg+xml">
  <title>回放 | 外网面板</title>
  <style>
    :root{
      --bg0:#060812;
      --bg1:#0b1730;
      --text:rgba(231,238,252,.96);
      --muted:rgba(165,180,207,.78);
      --muted2:rgba(124,141,180,.68);
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --surface:rgba(255,255,255,.06);
      --surface2:rgba(2,6,23,.32);
      --shadow1:0 16px 50px rgba(0,0,0,.46);
      --radius-panel:20px;
      --radius-card:16px;
      --radius-btn:14px;
      --radius-pill:999px;
      --cyan:#22d3ee;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#fb7185;
      --font:"Bahnschrift","Segoe UI Variable Display","Segoe UI","PingFang SC","Microsoft YaHei UI",system-ui,-apple-system,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    html,body{min-height:100%}
    html{background:linear-gradient(180deg, var(--bg0), var(--bg1))}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 850px at 18% 10%, rgba(34,211,238,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1)),
        url("/ui/bg_long.svg?v=ui-2026.02.15-01");
      background-repeat:no-repeat,no-repeat,no-repeat;
      background-position:18% 10%, top, center;
      background-size:auto,auto,cover;
      background-attachment:scroll,scroll,fixed;
      padding:18px 14px 28px;
      overflow-x:hidden;
    }
    @media (max-width:980px){body{background-attachment:scroll,scroll,scroll}}

    .wrap{max-width:1180px;margin:0 auto}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:14px 14px;
      border:1px solid var(--stroke);
      border-radius:var(--radius-panel);
      background:var(--surface);
      box-shadow:var(--shadow1);
      backdrop-filter:blur(8px);
      margin-bottom:12px;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mini{font-size:12px;color:var(--muted2);font-weight:900}
    #verLine{white-space:pre-line;display:inline-block;font-family:var(--mono);font-size:11px;color:var(--muted2)}

    .btn{
      appearance:none;
      min-height:48px;
      padding:12px 12px;
      border-radius:var(--radius-btn);
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      transition:background .18s ease,border-color .18s ease,transform .06s ease;
      text-decoration:none;
      display:inline-grid;
      place-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.08);border-color:var(--stroke2)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(34,211,238,.30);background:rgba(34,211,238,.16)}
    .btn.danger{border-color:rgba(251,113,133,.28);background:rgba(251,113,133,.14)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    input,select{
      border:1px solid var(--stroke);
      border-radius:var(--radius-btn);
      padding:10px 12px;
      font-weight:950;
      min-height:44px;
      background:rgba(2,6,23,.22);
      color:var(--text);
      font-family:var(--font);
      transition:border-color .18s ease, background .18s ease;
    }
    input:hover,select:hover{border-color:var(--stroke2)}
    input[type="datetime-local"]{width:240px}
    input[type="number"]{width:140px;text-align:right}
    select{min-width:180px}

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--radius-panel);
      background:var(--surface);
      box-shadow:var(--shadow1);
      backdrop-filter: blur(8px);
      padding:14px;
      overflow:hidden;
    }
    .sec{
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius-card);
      padding:12px;
      background:rgba(2,6,23,.22);
    }
    .sec-title{font-weight:950;letter-spacing:.2px;margin-bottom:10px}
    .hint{margin-top:10px;color:var(--muted2);font-size:12px;line-height:1.6}
    .hint.bad{color:var(--bad)}
    .hint.good{color:var(--good)}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .controls label{display:grid;gap:6px}
    .lbl{font-size:12px;color:var(--muted2);font-weight:950;letter-spacing:.2px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{font-size:12px;text-align:left;padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{color:var(--muted2);font-weight:950}
    td{color:var(--text);font-family:var(--mono)}
    .tblWrap{margin-top:12px;overflow:auto;max-height:70vh;border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-card)}
    :focus-visible{outline:3px solid rgba(56,189,248,.65);outline-offset:2px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="row">
        <a class="btn" href="/">返回面板</a>
        <a class="btn" href="/config">配置</a>
      </div>
      <div class="row">
        <span class="mini" id="who">--</span>
        <button class="btn danger" onclick="logout()">退出</button>
        <span class="mini" id="verLine">UI ui-2026.02.15-01</span>
      </div>
    </div>

    <div class="card">
      <div class="sec-title">数据回放 / 查询</div>
      <div class="sec">
        <div class="controls">
          <label>
            <span class="lbl">设备</span>
            <select id="devSel"></select>
          </label>
          <label>
            <span class="lbl">开始</span>
            <input id="from" type="datetime-local">
          </label>
          <label>
            <span class="lbl">结束</span>
            <input id="to" type="datetime-local">
          </label>
          <label>
            <span class="lbl">最多条数</span>
            <input id="limit" type="number" min="50" max="20000" step="50" value="2000">
          </label>
          <button class="btn primary" id="btnLoad" onclick="loadData()">查询</button>
          <button class="btn" onclick="exportJson()">导出 JSON</button>
          <button class="btn" onclick="exportCsv()">导出 CSV</button>
        </div>
        <div class="hint" id="meta">--</div>
        <div class="hint bad" id="msg" style="display:none"></div>
      </div>

      <div class="tblWrap">
        <table>
          <thead>
            <tr>
              <th>时间</th>
              <th>内塘(mm)</th>
              <th>外塘(mm)</th>
              <th>Δ(mm)</th>
              <th>闸门</th>
              <th>自动</th>
              <th>告警</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7">请先查询…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const UI_VERSION = 'ui-2026.02.15-01';
    const $ = (id)=>document.getElementById(id);
    let g_last = [];

    async function logout(){
      try{ await fetch('/api/auth/logout', {method:'POST'}); }catch(e){}
      location.href = '/login';
    }

    function showMsg(text){
      const el = $('msg');
      const t = (text || '').trim();
      if(!el) return;
      if(!t){ el.style.display='none'; el.textContent=''; return; }
      el.style.display='';
      el.textContent=t;
    }

    async function apiJson(url, opts){
      const r = await fetch(url, Object.assign({cache:'no-store'}, opts||{}));
      const tx = await r.text();
      let j = null; try{ j = tx ? JSON.parse(tx) : null }catch(e){}
      if(!r.ok) throw new Error((j && j.error) ? j.error : ('HTTP ' + r.status));
      return j;
    }

    function toLocalInputValue(d){
      const pad = (x)=> (x<10?('0'+x):(''+x));
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
        'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    async function loadMe(){
      try{
        const j = await apiJson('/api/auth/me');
        $('who').textContent = j && j.user ? ('用户 ' + j.user.username + ' | ' + j.user.role) : '--';
      }catch(e){
        location.href = '/login';
      }
    }

    async function loadDevices(){
      const sel = $('devSel');
      if(!sel) return;
      sel.innerHTML = '';
      try{
        const j = await apiJson('/api/devices');
        const list = (j && Array.isArray(j.devices)) ? j.devices : [];
        if(!list.length){
          const op = document.createElement('option');
          op.value = '';
          op.textContent = '(暂无设备)';
          sel.appendChild(op);
          return;
        }
        list.forEach((d)=>{
          const op = document.createElement('option');
          op.value = d.device_id || '';
          op.textContent = d.device_id || '';
          sel.appendChild(op);
        });
      }catch(e){
        const op = document.createElement('option');
        op.value = '';
        op.textContent = '(加载失败)';
        sel.appendChild(op);
      }
    }

    function fmtTs(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString();
      }catch(e){ return String(ts || '--'); }
    }

    function gateStateText(n){
      if(n === 1) return '开闸';
      if(n === 2) return '关闸';
      return '待机';
    }

    function alarmText(a){
      if(!a || !a.active) return '正常';
      const sev = (typeof a.severity === 'number') ? a.severity : 0;
      return 'S' + sev + ' ' + (a.text || 'alarm');
    }

    async function loadData(){
      const btn = $('btnLoad');
      if(btn) btn.disabled = true;
      showMsg('');
      const dev = $('devSel').value || '';
      const from = $('from').value;
      const to = $('to').value;
      const limit = parseInt($('limit').value, 10) || 2000;
      if(!dev){ showMsg('请选择设备'); if(btn) btn.disabled=false; return; }
      if(!from || !to){ showMsg('请选择开始/结束时间'); if(btn) btn.disabled=false; return; }

      try{
        const url = '/api/telemetry/range?device_id=' + encodeURIComponent(dev) +
          '&from=' + encodeURIComponent(from) +
          '&to=' + encodeURIComponent(to) +
          '&limit=' + encodeURIComponent(limit);
        const j = await apiJson(url);
        const rows = (j && Array.isArray(j.rows)) ? j.rows : [];
        g_last = rows;
        const tb = $('tbody');
        if(tb){
          if(!rows.length){
            tb.innerHTML = '<tr><td colspan="7">(空)</td></tr>';
          }else{
            tb.innerHTML = rows.map((r)=>{
              const t = r && r.payload ? r.payload : {};
              const s1 = t.sensor1 || {};
              const s2 = t.sensor2 || {};
              const inner = (s1 && s1.valid) ? (s1.mm|0) : null;
              const outer = (s2 && s2.valid) ? (s2.mm|0) : null;
              const delta = (inner != null && outer != null) ? (inner - outer) : null;
              const auto = t.auto_latched ? '锁定关' : (t.auto_gate ? '开' : '关');
              return '<tr>' +
                '<td>' + fmtTs(r.ts) + '</td>' +
                '<td>' + (inner==null?'--':inner) + '</td>' +
                '<td>' + (outer==null?'--':outer) + '</td>' +
                '<td>' + (delta==null?'--':delta) + '</td>' +
                '<td>' + gateStateText(t.gate_state) + '</td>' +
                '<td>' + auto + '</td>' +
                '<td>' + alarmText(t.alarm) + '</td>' +
              '</tr>';
            }).join('');
          }
        }
        const meta = $('meta');
        if(meta) meta.textContent = '返回 ' + rows.length + ' 条';
      }catch(e){
        showMsg('查询失败：' + e.message);
      }finally{
        if(btn) btn.disabled = false;
      }
    }
    window.loadData = loadData;

    function downloadText(filename, content){
      const b = new Blob([content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(b);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    function exportJson(){
      const dev = $('devSel').value || 'device';
      const stamp = Date.now();
      downloadText('telemetry_' + dev + '_' + stamp + '.json', JSON.stringify(g_last || [], null, 2));
    }
    window.exportJson = exportJson;

    function csvEsc(s){
      const t = (s == null) ? '' : ('' + s);
      if(/[\",\\n]/.test(t)) return '\"' + t.replace(/\"/g, '\"\"') + '\"';
      return t;
    }

    function exportCsv(){
      const dev = $('devSel').value || 'device';
      const stamp = Date.now();
      const rows = Array.isArray(g_last) ? g_last : [];
      const head = ['ts','inner_mm','outer_mm','delta_mm','gate_state','auto_gate','auto_latched','alarm_active','alarm_severity','alarm_text'];
      const lines = [head.join(',')];
      rows.forEach((r)=>{
        const t = r && r.payload ? r.payload : {};
        const s1 = t.sensor1 || {};
        const s2 = t.sensor2 || {};
        const inner = (s1 && s1.valid) ? (s1.mm|0) : '';
        const outer = (s2 && s2.valid) ? (s2.mm|0) : '';
        const delta = (inner!=='' && outer!=='') ? ((inner|0) - (outer|0)) : '';
        const a = t.alarm || {};
        const line = [
          r.ts || '',
          inner,
          outer,
          delta,
          t.gate_state ?? '',
          t.auto_gate ? 1 : 0,
          t.auto_latched ? 1 : 0,
          a.active ? 1 : 0,
          (a.severity ?? ''),
          (a.text ?? '')
        ].map(csvEsc).join(',');
        lines.push(line);
      });
      downloadText('telemetry_' + dev + '_' + stamp + '.csv', lines.join('\\n'));
    }
    window.exportCsv = exportCsv;

    (function init(){
      $('verLine').textContent = 'UI ' + UI_VERSION;
      loadMe();
      loadDevices().then(()=>{
        const now = new Date();
        const from = new Date(now.getTime() - 60*60*1000);
        $('from').value = toLocalInputValue(from);
        $('to').value = toLocalInputValue(now);
      });
    })();
  </script>
</body>
</html>

