<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/ui/favicon.svg?v=ui-2026.02.15-01" type="image/svg+xml">
  <title>回放 | 外网面板</title>
  <style>
    :root{
      --bg0:#060812;
      --bg1:#0b1730;
      --text:rgba(231,238,252,.96);
      --muted:rgba(165,180,207,.78);
      --muted2:rgba(124,141,180,.68);
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --surface:rgba(255,255,255,.06);
      --surface2:rgba(2,6,23,.32);
      --shadow1:0 16px 50px rgba(0,0,0,.46);
      --radius-panel:20px;
      --radius-card:16px;
      --radius-btn:14px;
      --radius-pill:999px;
      --cyan:#22d3ee;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#fb7185;
      --font:"Bahnschrift","Segoe UI Variable Display","Segoe UI","PingFang SC","Microsoft YaHei UI",system-ui,-apple-system,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    html,body{min-height:100%}
    html{background:linear-gradient(180deg, var(--bg0), var(--bg1))}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 850px at 18% 10%, rgba(34,211,238,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1)),
        url("/ui/bg_long.svg?v=ui-2026.02.15-01");
      background-repeat:no-repeat,no-repeat,no-repeat;
      background-position:18% 10%, top, center;
      background-size:auto,auto,cover;
      background-attachment:scroll,scroll,fixed;
      padding:18px 14px 28px;
      overflow-x:hidden;
    }
    @media (max-width:980px){body{background-attachment:scroll,scroll,scroll}}

    .wrap{max-width:1180px;margin:0 auto}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:14px 14px;
      border:1px solid var(--stroke);
      border-radius:var(--radius-panel);
      background:var(--surface);
      box-shadow:var(--shadow1);
      backdrop-filter:blur(8px);
      margin-bottom:12px;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mini{font-size:12px;color:var(--muted2);font-weight:900}
    #verLine{white-space:pre-line;display:inline-block;font-family:var(--mono);font-size:11px;color:var(--muted2)}

    .btn{
      appearance:none;
      min-height:48px;
      padding:12px 12px;
      border-radius:var(--radius-btn);
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      transition:background .18s ease,border-color .18s ease,transform .06s ease;
      text-decoration:none;
      display:inline-grid;
      place-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.08);border-color:var(--stroke2)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(34,211,238,.30);background:rgba(34,211,238,.16)}
    .btn.danger{border-color:rgba(251,113,133,.28);background:rgba(251,113,133,.14)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    input,select{
      border:1px solid var(--stroke);
      border-radius:var(--radius-btn);
      padding:10px 12px;
      font-weight:950;
      min-height:44px;
      background:rgba(2,6,23,.22);
      color:var(--text);
      font-family:var(--font);
      transition:border-color .18s ease, background .18s ease;
    }
    input:hover,select:hover{border-color:var(--stroke2)}
    input[type="datetime-local"]{width:240px}
    input[type="number"]{width:140px;text-align:right}
    select{min-width:180px}

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--radius-panel);
      background:var(--surface);
      box-shadow:var(--shadow1);
      backdrop-filter: blur(8px);
      padding:14px;
      overflow:hidden;
    }
    .sec{
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius-card);
      padding:12px;
      background:rgba(2,6,23,.22);
    }
    .sec-title{font-weight:950;letter-spacing:.2px;margin-bottom:10px}
    .hint{margin-top:10px;color:var(--muted2);font-size:12px;line-height:1.6}
    .hint.bad{color:var(--bad)}
    .hint.good{color:var(--good)}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .controls label{display:grid;gap:6px}
    .lbl{font-size:12px;color:var(--muted2);font-weight:950;letter-spacing:.2px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{font-size:12px;text-align:left;padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{color:var(--muted2);font-weight:950}
    td{color:var(--text);font-family:var(--mono)}
    .tblWrap{margin-top:12px;overflow:auto;max-height:70vh;border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-card)}
    tbody tr:hover td{background:rgba(255,255,255,.03);cursor:pointer}
    tbody tr.sel td{background:rgba(34,211,238,.10)}

    .vizWrap{
      margin-top:12px;
      border-radius:var(--radius-card);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(2,6,23,.22));
      overflow:hidden;
    }
    .vizMain{padding:12px}
    .chartCanvas{
      width:100%;
      height:340px;
      display:block;
      border-radius:12px;
      background:
        radial-gradient(900px 520px at 14% 10%, rgba(34,211,238,.12), transparent 55%),
        rgba(4,9,20,.68);
    }
    .vizHud{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.06);
      background:rgba(2,6,23,.22);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);font-size:12px;font-weight:950;font-family:var(--mono)}
    .tag.good{border-color:rgba(34,197,94,.25);color:#b7f7cc;background:rgba(34,197,94,.08)}
    .tag.bad{border-color:rgba(251,113,133,.28);color:#ffc1ce;background:rgba(251,113,133,.08)}
    .tag.warn{border-color:rgba(245,158,11,.28);color:#ffd59a;background:rgba(245,158,11,.08)}
    :focus-visible{outline:3px solid rgba(56,189,248,.65);outline-offset:2px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="row">
        <a class="btn" href="/">返回面板</a>
        <a class="btn" href="/device-config">设备配置</a>
        <a class="btn" href="/config">管理</a>
      </div>
      <div class="row">
        <span class="mini" id="who">--</span>
        <button class="btn danger" onclick="logout()">退出</button>
        <span class="mini" id="verLine">UI ui-2026.02.15-01</span>
      </div>
    </div>

    <div class="card">
      <div class="sec-title">数据回放 / 查询</div>
      <div class="sec">
        <div class="controls">
          <label>
            <span class="lbl">设备</span>
            <select id="devSel"></select>
          </label>
          <label>
            <span class="lbl">开始</span>
            <input id="from" type="datetime-local">
          </label>
          <label>
            <span class="lbl">结束</span>
            <input id="to" type="datetime-local">
          </label>
          <label>
            <span class="lbl">最多条数</span>
            <input id="limit" type="number" min="50" max="20000" step="50" value="2000">
          </label>
          <button class="btn primary" id="btnLoad" onclick="loadData()">查询</button>
          <button class="btn" onclick="exportJson()">导出 JSON</button>
          <button class="btn" onclick="exportCsv()">导出 CSV</button>
        </div>
        <div class="hint" id="meta">--</div>
        <div class="hint bad" id="msg" style="display:none"></div>
      </div>

      <div style="height:12px"></div>

      <div class="sec" aria-label="水位可视化回放">
        <div class="sec-title">水位可视化</div>
        <div class="controls" style="align-items:center">
          <button class="btn" id="btnPlay" onclick="togglePlay()">播放</button>
          <label>
            <span class="lbl">速度</span>
            <select id="speed">
              <option value="1">1x</option>
              <option value="2">2x</option>
              <option value="4">4x</option>
              <option value="8">8x</option>
            </select>
          </label>
          <label style="flex:1 1 360px;min-width:220px">
            <span class="lbl">进度</span>
            <input id="scrub" type="range" min="0" max="0" step="1" value="0" oninput="scrubTo(this.value)">
          </label>
          <span class="mini" id="curTs">--</span>
        </div>

        <div class="vizWrap">
          <div class="vizMain">
            <canvas id="chart" class="chartCanvas" role="img" aria-label="水位曲线"></canvas>
          </div>
          <div class="vizHud" aria-label="回放读数">
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <span class="tag" id="hudInner">内塘 --</span>
              <span class="tag" id="hudOuter">外塘 --</span>
              <span class="tag" id="hudDelta">Δ --</span>
              <span class="tag" id="hudGate">闸门 --</span>
              <span class="tag" id="hudAuto">自动 --</span>
            </div>
            <div class="mini" id="hudIdx">--</div>
          </div>
        </div>
        <div class="hint">提示：点击表格行可定位到该条数据；播放会从当前条开始自动递进。</div>
      </div>

      <div class="tblWrap">
        <table>
          <thead>
            <tr>
              <th>时间</th>
              <th>内塘(mm)</th>
              <th>外塘(mm)</th>
              <th>Δ(mm)</th>
              <th>闸门</th>
              <th>自动</th>
              <th>告警</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7">请先查询…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const UI_VERSION = 'ui-2026.02.15-01';
    const $ = (id)=>document.getElementById(id);
    let g_last = [];
    let g_curIdx = 0;
    let g_playing = false;
    let g_playTimer = 0;
    let g_chartData = [];
    let g_chartRange = null;

    async function logout(){
      try{ await fetch('/api/auth/logout', {method:'POST'}); }catch(e){}
      location.href = '/login';
    }

    function showMsg(text){
      const el = $('msg');
      const t = (text || '').trim();
      if(!el) return;
      if(!t){ el.style.display='none'; el.textContent=''; return; }
      el.style.display='';
      el.textContent=t;
    }

    async function apiJson(url, opts){
      const r = await fetch(url, Object.assign({cache:'no-store'}, opts||{}));
      const tx = await r.text();
      let j = null; try{ j = tx ? JSON.parse(tx) : null }catch(e){}
      if(!r.ok) throw new Error((j && j.error) ? j.error : ('HTTP ' + r.status));
      return j;
    }

    function toLocalInputValue(d){
      const pad = (x)=> (x<10?('0'+x):(''+x));
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
        'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    async function loadMe(){
      try{
        const j = await apiJson('/api/auth/me');
        $('who').textContent = j && j.user ? ('用户 ' + j.user.username + ' | ' + j.user.role) : '--';
      }catch(e){
        location.href = '/login';
      }
    }

    async function loadDevices(){
      const sel = $('devSel');
      if(!sel) return;
      sel.innerHTML = '';
      try{
        const j = await apiJson('/api/devices');
        const list = (j && Array.isArray(j.devices)) ? j.devices : [];
        if(!list.length){
          const op = document.createElement('option');
          op.value = '';
          op.textContent = '(暂无设备)';
          sel.appendChild(op);
          return;
        }
        list.forEach((d)=>{
          const op = document.createElement('option');
          op.value = d.device_id || '';
          op.textContent = d.device_id || '';
          sel.appendChild(op);
        });
      }catch(e){
        const op = document.createElement('option');
        op.value = '';
        op.textContent = '(加载失败)';
        sel.appendChild(op);
      }
    }

    function fmtTs(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString();
      }catch(e){ return String(ts || '--'); }
    }

    function gateStateText(n){
      if(n === 1) return '开闸';
      if(n === 2) return '关闸';
      return '待机';
    }

    function alarmText(a){
      if(!a || !a.active) return '正常';
      const sev = (typeof a.severity === 'number') ? a.severity : 0;
      return 'S' + sev + ' ' + (a.text || 'alarm');
    }

    function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

    function localInputToIso(v){
      try{
        const d = new Date(String(v || ''));
        if(!Number.isFinite(d.getTime())) return '';
        return d.toISOString();
      }catch(e){ return ''; }
    }

    function fmtTick(ts){
      try{
        const d = new Date(ts);
        const pad = (n)=> (n<10?('0'+n):(''+n));
        return pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
      }catch(e){ return '--'; }
    }

    function niceStep(range, target){
      const t = target || 5;
      if(!Number.isFinite(range) || range <= 0) return 10;
      const rough = range / t;
      const pow = Math.pow(10, Math.floor(Math.log10(rough)));
      const norm = rough / pow;
      let nice = 1;
      if(norm < 1.5) nice = 1;
      else if(norm < 3) nice = 2;
      else if(norm < 7) nice = 5;
      else nice = 10;
      return nice * pow;
    }

    function buildTicks(min, max, target){
      const step = niceStep((max - min) || 1, target || 5);
      const start = Math.floor(min / step) * step;
      const end = Math.ceil(max / step) * step;
      const ticks = [];
      for(let v = start; v <= end + step * 0.5; v += step){
        ticks.push(Math.round(v));
      }
      return ticks;
    }

    function prepareChartData(rows){
      const data = (Array.isArray(rows) ? rows : []).map((r)=>{
        const t = r && r.payload ? r.payload : {};
        const s1 = t.sensor1 || {};
        const s2 = t.sensor2 || {};
        return {
          ts: new Date(r.ts).getTime(),
          inner: (s1 && s1.valid) ? (s1.mm|0) : null,
          outer: (s2 && s2.valid) ? (s2.mm|0) : null,
        };
      });
      g_chartData = data;
      const vals = [];
      data.forEach((d)=>{
        if(d.inner != null) vals.push(d.inner);
        if(d.outer != null) vals.push(d.outer);
      });
      const yMin = vals.length ? Math.min(...vals) : 0;
      const yMax = vals.length ? Math.max(...vals) : 0;
      const pad = vals.length ? Math.max(30, Math.round((yMax - yMin || 60) * 0.18)) : 60;
      const tMin = data.length ? Math.min(...data.map(d=>d.ts)) : null;
      const tMax = data.length ? Math.max(...data.map(d=>d.ts)) : null;
      g_chartRange = {
        tMin,
        tMax: (tMax === tMin && tMax != null) ? (tMax + 1000) : tMax,
        yMin: vals.length ? Math.max(0, yMin - pad) : 0,
        yMax: vals.length ? (yMax + pad) : 120,
      };
    }

    function renderChart(highlightIdx){
      const canvas = $('chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth || canvas.offsetWidth || 800;
      const height = canvas.clientHeight || 320;
      canvas.width = Math.round(width * dpr);
      canvas.height = Math.round(height * dpr);
      ctx.save();
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, width, height);

      const pad = {l:72, r:18, t:16, b:44};
      const plotW = Math.max(10, width - pad.l - pad.r);
      const plotH = Math.max(10, height - pad.t - pad.b);

      ctx.fillStyle = 'rgba(4,9,20,.68)';
      ctx.fillRect(0, 0, width, height);

      const range = g_chartRange || {};
      const hasData = g_chartData.length && range.tMin != null && range.tMax != null;
      if(!hasData){
        ctx.fillStyle = 'rgba(148,163,184,.84)';
        ctx.font = '14px var(--font, \"Bahnschrift\")';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText('暂无数据，请先查询。', pad.l, pad.t + 28);
        ctx.restore();
        return;
      }

      const tMin = range.tMin;
      const tMax = range.tMax;
      const yMin = range.yMin;
      const yMax = range.yMax;
      const mapX = (ts)=> pad.l + ((ts - tMin) / (tMax - tMin)) * plotW;
      const mapY = (v)=> pad.t + plotH - ((v - yMin) / ((yMax - yMin) || 1)) * plotH;

      // Grid Y
      ctx.lineWidth = 1;
      const yTicks = buildTicks(yMin, yMax, 5);
      yTicks.forEach((v)=>{
        const y = mapY(v);
        ctx.strokeStyle = 'rgba(255,255,255,.08)';
        ctx.beginPath();
        ctx.moveTo(pad.l, y + 0.5);
        ctx.lineTo(width - pad.r, y + 0.5);
        ctx.stroke();

        ctx.fillStyle = 'rgba(148,163,184,.9)';
        ctx.font = '12px var(--font, \"Bahnschrift\")';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(v + ' mm', pad.l - 10, y);
      });

      // Grid X
      const xTicks = 4;
      ctx.strokeStyle = 'rgba(255,255,255,.06)';
      for(let i=0;i<=xTicks;i++){
        const ts = tMin + ((tMax - tMin) * i / xTicks);
        const x = mapX(ts);
        ctx.beginPath();
        ctx.moveTo(x + 0.5, pad.t);
        ctx.lineTo(x + 0.5, pad.t + plotH);
        ctx.stroke();

        ctx.fillStyle = 'rgba(148,163,184,.9)';
        ctx.font = '12px var(--font, \"Bahnschrift\")';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(fmtTick(ts), x, pad.t + plotH + 8);
      }

      function drawSeries(selector, color, shadow){
        ctx.beginPath();
        let started = false;
        g_chartData.forEach((d)=>{
          const v = selector(d);
          if(v == null){ started = false; return; }
          const x = mapX(d.ts);
          const y = mapY(v);
          if(!started){ ctx.moveTo(x, y); started = true; }
          else ctx.lineTo(x, y);
        });
        ctx.lineWidth = 2;
        ctx.strokeStyle = color;
        ctx.shadowColor = shadow || 'transparent';
        ctx.shadowBlur = 12;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.stroke();
        ctx.shadowColor = 'transparent';
      }

      drawSeries((d)=>d.outer, '#38bdf8', 'rgba(56,189,248,.30)');
      drawSeries((d)=>d.inner, '#4ade80', 'rgba(74,222,128,.30)');

      // Legend
      const legend = [
        {label:'外塘', color:'#38bdf8'},
        {label:'内塘', color:'#4ade80'},
      ];
      legend.forEach((l, i)=>{
        const y = pad.t + 6 + i * 20;
        ctx.fillStyle = l.color;
        ctx.fillRect(pad.l, y, 18, 4);
        ctx.fillStyle = 'rgba(226,232,240,.94)';
        ctx.font = '13px var(--font, \"Bahnschrift\")';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(l.label, pad.l + 26, y + 2);
      });

      // Highlight current
      if(typeof highlightIdx === 'number'){
        const d = g_chartData[highlightIdx];
        if(d){
          const x = mapX(d.ts);
          ctx.strokeStyle = 'rgba(255,255,255,.24)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x + 0.5, pad.t);
          ctx.lineTo(x + 0.5, pad.t + plotH);
          ctx.stroke();

          const drawDot = (v, color)=>{
            if(v == null) return;
            const y = mapY(v);
            ctx.fillStyle = color;
            ctx.strokeStyle = 'rgba(0,0,0,.45)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
          };
          drawDot(d.outer, '#38bdf8');
          drawDot(d.inner, '#4ade80');
        }
      }

      ctx.restore();
    }

    function setTag(id, text, kind){
      const el = $(id);
      if(!el) return;
      el.textContent = text;
      el.className = 'tag' + (kind ? (' ' + kind) : '');
    }

    function updateTableSel(){
      const tb = $('tbody');
      if(!tb) return;
      const trs = tb.querySelectorAll('tr[data-idx]');
      trs.forEach((tr)=>{
        const i = parseInt(tr.getAttribute('data-idx') || '-1', 10);
        tr.className = (i === g_curIdx) ? 'sel' : '';
      });
    }

    function renderVizRow(row, idx){
      const curTs = $('curTs');
      const hudIdx = $('hudIdx');
      if(!row || !row.payload){
        if(curTs) curTs.textContent = '--';
        if(hudIdx) hudIdx.textContent = '--';
        setTag('hudInner', '内塘 --', '');
        setTag('hudOuter', '外塘 --', '');
        setTag('hudDelta', 'Δ --', '');
        setTag('hudGate', '闸门 --', '');
        setTag('hudAuto', '自动 --', '');
        return;
      }

      const r = row;
      const t = r.payload || {};
      const s1 = t.sensor1 || {};
      const s2 = t.sensor2 || {};
      const innerOk = !!s1.valid;
      const outerOk = !!s2.valid;
      const inner = innerOk ? (s1.mm|0) : null;
      const outer = outerOk ? (s2.mm|0) : null;
      const delta = (inner != null && outer != null) ? (inner - outer) : null;

      if(curTs) curTs.textContent = fmtTs(r.ts);
      if(hudIdx) hudIdx.textContent = (typeof idx === 'number') ? ('#' + (idx + 1) + ' / ' + (g_last.length || 0)) : '--';

      setTag('hudInner', '内塘 ' + (inner==null?'--':(inner + 'mm')), innerOk ? 'good' : 'bad');
      setTag('hudOuter', '外塘 ' + (outer==null?'--':(outer + 'mm')), outerOk ? 'good' : 'bad');

      if(delta == null){
        setTag('hudDelta', 'Δ --', '');
      }else{
        const kind = (Math.abs(delta) > 80) ? 'warn' : 'good';
        setTag('hudDelta', 'Δ ' + delta + 'mm', kind);
      }

      setTag('hudGate', '闸门 ' + gateStateText(t.gate_state), '');
      const auto = t.auto_latched ? '锁定关' : (t.auto_gate ? '开' : '关');
      setTag('hudAuto', '自动 ' + auto, t.auto_latched ? 'bad' : (t.auto_gate ? 'good' : ''));
    }

    function stopPlay(){
      if(g_playTimer){
        clearInterval(g_playTimer);
        g_playTimer = 0;
      }
      g_playing = false;
      const b = $('btnPlay');
      if(b) b.textContent = '播放';
    }

    function playStepMs(){
      const s = parseInt(($('speed') && $('speed').value) || '1', 10) || 1;
      const base = 450; // ms/step at 1x
      return Math.max(35, Math.round(base / Math.max(1, s)));
    }

    function startPlay(){
      if(!g_last.length) return;
      if(g_playTimer) clearInterval(g_playTimer);
      g_playing = true;
      const b = $('btnPlay');
      if(b) b.textContent = '暂停';
      g_playTimer = setInterval(()=>{
        if(!g_last.length){ stopPlay(); return; }
        if(g_curIdx >= g_last.length - 1){ stopPlay(); return; }
        selectIdx(g_curIdx + 1, {keepPlaying:true});
      }, playStepMs());
    }

    function togglePlay(){
      if(g_playing) stopPlay();
      else startPlay();
    }
    window.togglePlay = togglePlay;

    function selectIdx(i, opts){
      const o = opts || {};
      const keepPlaying = !!o.keepPlaying;
      if(!keepPlaying) stopPlay();
      const n = g_last.length || 0;
      if(!n){
        g_curIdx = 0;
        renderVizRow(null, 0);
        renderChart(null);
        updateTableSel();
        return;
      }
      const idx = clamp(parseInt(i, 10) || 0, 0, n - 1);
      g_curIdx = idx;
      const sc = $('scrub');
      if(sc){
        sc.max = String(Math.max(0, n - 1));
        sc.value = String(idx);
      }
      renderVizRow(g_last[idx], idx);
      renderChart(idx);
      updateTableSel();
    }
    window.selectIdx = selectIdx;

    function scrubTo(v){
      selectIdx(v);
    }
    window.scrubTo = scrubTo;

    async function loadData(){
      const btn = $('btnLoad');
      if(btn) btn.disabled = true;
      showMsg('');
      const dev = $('devSel').value || '';
      const from = $('from').value;
      const to = $('to').value;
      const limit = parseInt($('limit').value, 10) || 2000;
      if(!dev){ showMsg('请选择设备'); if(btn) btn.disabled=false; return; }
      if(!from || !to){ showMsg('请选择开始/结束时间'); if(btn) btn.disabled=false; return; }

      try{
        const fromIso = localInputToIso(from);
        const toIso = localInputToIso(to);
        if(!fromIso || !toIso) throw new Error('bad_time_range');
        const url = '/api/telemetry/range?device_id=' + encodeURIComponent(dev) +
          '&from=' + encodeURIComponent(fromIso) +
          '&to=' + encodeURIComponent(toIso) +
          '&limit=' + encodeURIComponent(limit);
        const j = await apiJson(url);
        const rows = (j && Array.isArray(j.rows)) ? j.rows : [];
        g_last = rows;
        prepareChartData(rows);
        const tb = $('tbody');
        if(tb){
          if(!rows.length){
            tb.innerHTML = '<tr><td colspan="7">(空)</td></tr>';
          }else{
            tb.innerHTML = rows.map((r, i)=>{
              const t = r && r.payload ? r.payload : {};
              const s1 = t.sensor1 || {};
              const s2 = t.sensor2 || {};
              const inner = (s1 && s1.valid) ? (s1.mm|0) : null;
              const outer = (s2 && s2.valid) ? (s2.mm|0) : null;
              const delta = (inner != null && outer != null) ? (inner - outer) : null;
              const auto = t.auto_latched ? '锁定关' : (t.auto_gate ? '开' : '关');
              return '<tr data-idx=\"' + i + '\" onclick=\"selectIdx(' + i + ')\">' +
                '<td>' + fmtTs(r.ts) + '</td>' +
                '<td>' + (inner==null?'--':inner) + '</td>' +
                '<td>' + (outer==null?'--':outer) + '</td>' +
                '<td>' + (delta==null?'--':delta) + '</td>' +
                '<td>' + gateStateText(t.gate_state) + '</td>' +
                '<td>' + auto + '</td>' +
                '<td>' + alarmText(t.alarm) + '</td>' +
              '</tr>';
            }).join('');
          }
        }
        const meta = $('meta');
        if(meta) meta.textContent = '返回 ' + rows.length + ' 条';

        // Reset scrub + visualization.
        const sc = $('scrub');
        if(sc){
          sc.max = String(Math.max(0, rows.length - 1));
          sc.value = String(Math.max(0, rows.length - 1));
        }
        selectIdx(Math.max(0, rows.length - 1), {keepPlaying:false});
      }catch(e){
        showMsg('查询失败：' + e.message);
      }finally{
        if(btn) btn.disabled = false;
      }
    }
    window.loadData = loadData;

    function downloadText(filename, content){
      const b = new Blob([content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(b);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    function exportJson(){
      const dev = $('devSel').value || 'device';
      const stamp = Date.now();
      downloadText('telemetry_' + dev + '_' + stamp + '.json', JSON.stringify(g_last || [], null, 2));
    }
    window.exportJson = exportJson;

    function csvEsc(s){
      const t = (s == null) ? '' : ('' + s);
      if(/[\",\\n]/.test(t)) return '\"' + t.replace(/\"/g, '\"\"') + '\"';
      return t;
    }

    function exportCsv(){
      const dev = $('devSel').value || 'device';
      const stamp = Date.now();
      const rows = Array.isArray(g_last) ? g_last : [];
      const head = ['ts','inner_mm','outer_mm','delta_mm','gate_state','auto_gate','auto_latched','alarm_active','alarm_severity','alarm_text'];
      const lines = [head.join(',')];
      rows.forEach((r)=>{
        const t = r && r.payload ? r.payload : {};
        const s1 = t.sensor1 || {};
        const s2 = t.sensor2 || {};
        const inner = (s1 && s1.valid) ? (s1.mm|0) : '';
        const outer = (s2 && s2.valid) ? (s2.mm|0) : '';
        const delta = (inner!=='' && outer!=='') ? ((inner|0) - (outer|0)) : '';
        const a = t.alarm || {};
        const line = [
          r.ts || '',
          inner,
          outer,
          delta,
          t.gate_state ?? '',
          t.auto_gate ? 1 : 0,
          t.auto_latched ? 1 : 0,
          a.active ? 1 : 0,
          (a.severity ?? ''),
          (a.text ?? '')
        ].map(csvEsc).join(',');
        lines.push(line);
      });
      downloadText('telemetry_' + dev + '_' + stamp + '.csv', lines.join('\\n'));
    }
    window.exportCsv = exportCsv;

    (function init(){
      $('verLine').textContent = 'UI ' + UI_VERSION;
      loadMe();
      prepareChartData([]);
      renderChart(null);
      renderVizRow(null, 0);
      const sp = $('speed');
      if(sp){
        sp.addEventListener('change', ()=>{
          if(g_playing){
            // Restart interval with the new speed.
            startPlay();
          }
        });
      }
      window.addEventListener('resize', ()=>renderChart(g_curIdx));
      loadDevices().then(()=>{
        const now = new Date();
        const from = new Date(now.getTime() - 60*60*1000);
        $('from').value = toLocalInputValue(from);
        $('to').value = toLocalInputValue(now);
      });
    })();
  </script>
</body>
</html>
