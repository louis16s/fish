<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fish 控制面板</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body class="page">
  <header class="top">
    <div class="top-left">
      <div class="dot"></div>
      <div>
        <div class="title">Fish 控制面板</div>
        <div class="sub" id="statusLine">连接中…</div>
      </div>
    </div>
    <form method="post" action="/logout">
      <button class="btn" type="submit">退出</button>
    </form>
  </header>

  <main class="grid">
    <section class="card">
      <div class="card-title">水位</div>
      <div class="kv">
        <div class="k">内塘</div>
        <div class="v" id="innerLevel">--</div>
        <div class="k">外塘</div>
        <div class="v" id="outerLevel">--</div>
        <div class="k">水位差</div>
        <div class="v" id="delta">--</div>
      </div>
      <div class="row">
        <div class="pill" id="innerOnline">内塘：--</div>
        <div class="pill" id="outerOnline">外塘：--</div>
      </div>
    </section>

    <section class="card">
      <div class="card-title">闸门</div>
      <div class="kv">
        <div class="k">状态</div>
        <div class="v" id="gateState">--</div>
        <div class="k">自动</div>
        <div class="v" id="autoState">--</div>
      </div>
      <div class="controls">
        <button class="btn primary" onclick="cmd('gate_open')">开闸</button>
        <button class="btn primary" onclick="cmd('gate_close')">关闸</button>
        <button class="btn danger" onclick="cmd('gate_stop')">停止</button>
        <button class="btn" onclick="cmd('auto_on')">开启自动</button>
        <button class="btn" onclick="cmd('auto_off')">手动接管(暂停)</button>
        <button class="btn" onclick="cmd('manual_end')">恢复自动</button>
        <button class="btn warn" onclick="confirmLatch()">关闭自动(锁定)</button>
      </div>
      <div class="hint" id="interlock">互锁：--</div>
    </section>

    <section class="card">
      <div class="card-title">告警</div>
      <div class="alarm" id="alarmLine">--</div>
      <div class="hint mono" id="metaLine">--</div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    function gateStateText(s){ if(s===1) return '开闸中'; if(s===2) return '关闸中'; return '待机'; }
    function boolText(b){ return b ? '是' : '否'; }

    async function cmd(c){
      try{
        const r = await fetch('/api/cmd', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cmd:c})});
        const j = await r.json().catch(() => ({}));
        if(!r.ok) throw new Error(j.error || 'request_failed');
      }catch(e){
        $('statusLine').textContent = '命令失败：' + (e.message || 'unknown');
      }
    }

    function confirmLatch(){
      if(!confirm('确认关闭自动(锁定)？需要手动开启自动才能恢复。')) return;
      cmd('auto_latch_off');
    }

    function render(t){
      if(!t){
        $('innerLevel').textContent='--';
        $('outerLevel').textContent='--';
        $('delta').textContent='--';
        $('gateState').textContent='--';
        $('autoState').textContent='--';
        $('innerOnline').textContent='内塘：--';
        $('outerOnline').textContent='外塘：--';
        $('alarmLine').textContent='--';
        $('interlock').textContent='互锁：--';
        $('metaLine').textContent='--';
        return;
      }

      const s1 = t.sensor1 || {};
      const s2 = t.sensor2 || {};
      $('innerLevel').textContent = s1.valid ? (s1.mm + ' mm') : '离线';
      $('outerLevel').textContent = s2.valid ? (s2.mm + ' mm') : '离线';
      $('delta').textContent = (s1.valid && s2.valid) ? ((s1.mm - s2.mm) + ' mm') : '--';

      $('innerOnline').textContent = '内塘：' + (s1.online ? '在线' : '离线');
      $('outerOnline').textContent = '外塘：' + (s2.online ? '在线' : '离线');

      $('gateState').textContent = gateStateText(t.gate_state);
      const auto = (t.auto_latched ? '锁定关闭' : (t.auto_gate ? '已启用' : '已关闭'));
      $('autoState').textContent = auto;

      const reason = (t.ctrl && t.ctrl.reason) ? t.ctrl.reason : '';
      $('interlock').textContent = '互锁：' + (reason || '正常');

      if(t.alarm && t.alarm.active){
        $('alarmLine').textContent = (t.alarm.text || '告警');
        $('alarmLine').className = 'alarm alarm-on';
      }else{
        $('alarmLine').textContent = 'normal';
        $('alarmLine').className = 'alarm';
      }

      const age = t.net && typeof t.net.rssi === 'number' ? `RSSI ${t.net.rssi}dBm` : '';
      const ip = t.net && t.net.ip ? `IP ${t.net.ip}` : '';
      const fw = t.fw && t.fw.current ? `FW ${t.fw.current}` : '';
      $('metaLine').textContent = [fw, ip, age].filter(Boolean).join(' | ');
    }

    function setStatus(text){ $('statusLine').textContent = text; }

    async function bootstrap(){
      try{
        const s = await (await fetch('/api/state')).json();
        if(!s.mqtt_connected) setStatus('MQTT 未连接');
        render(s.telemetry);
      }catch(e){
        setStatus('加载失败');
      }
    }

    function connectWs(){
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${proto}//${location.host}/ws`);
      ws.onopen = () => setStatus('已连接');
      ws.onclose = () => { setStatus('断开，重连中…'); setTimeout(connectWs, 1500); };
      ws.onmessage = (ev) => {
        try{
          const m = JSON.parse(ev.data);
          if(m.type === 'hello'){
            setStatus(m.mqtt_connected ? '已连接' : 'MQTT 未连接');
          }
          if(m.type === 'telemetry'){
            render(m.data);
          }
        }catch(e){}
      };
    }

    bootstrap();
    connectWs();
  </script>
</body>
</html>

