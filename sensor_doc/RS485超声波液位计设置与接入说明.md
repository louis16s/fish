# RS485超声波液位计设置与接入说明（基于现有文档提取）

## 1. 传感器通信协议与参数
- 协议：Modbus RTU（RS485，半双工，主从应答）
- 推荐帧间隔：主机两帧之间建议 `>= 1s`（文档原文建议）
- 串口参数：`9600, 8, 1, N`（9600bps，8数据位，1停止位，无校验）
- CRC：`CRC-16`，多项式 `0xA001`，低字节在前

## 2. 寄存器定义（只读）
- `0x0000`：液位值（2字节，整数，单位毫米等比例值）
- `0x0001`：空距值（2字节）
- `0x0002`：安装高度（2字节）
- `0x0003`：温度值（2字节，放大10倍，例如20.0℃对应200）
- `0x0004`：继电器状态（2字节，低4位有效）
- `0x0005`：盲区（2字节）

数据缩放说明：
- 液位值 `2098` 表示 `2.098m`
- 温度值 `200` 表示 `20.0℃`

## 3. 功能码与帧格式
- 使用功能码：`0x03`（读保持寄存器）
- 请求帧格式：`[地址][03][起始寄存器Hi][起始寄存器Lo][数量Hi][数量Lo][CRCLo][CRCHi]`
- 响应帧格式：`[地址][03][字节数N][数据...][CRCLo][CRCHi]`

错误响应：
- 功能码返回 `0x80 + 原功能码`
- 异常码：`0x01/0x02/0x03` 等

## 4. 文档中的读液位示例
读取 `地址=0x01` 的液位寄存器 `0x0000`（读1个寄存器）：
- 请求：`01 03 00 00 00 01 84 0A`
- 响应示例：`01 03 02 05 78 BB 36`
- 解析：`0x0578 = 1400`，即 `1.400m`

## 5. 双传感器接线与地址建议
目标：同一条 RS485 总线接两只液位计，由 ESP32S3 轮询比较水位。

- 接线：
  - 传感器1 `A -> 总线A`，`B -> 总线B`
  - 传感器2 `A -> 总线A`，`B -> 总线B`
  - 与控制板地参考保持一致
- 地址：
  - 传感器1设置为 `0x01`
  - 传感器2设置为 `0x02`
  - 地址菜单：文档提到仪表菜单 `P07`
- 参数一致性：
  - 两只传感器与主机都设置为 `9600,8,1,N`

## 6. 可直接使用的两条轮询命令
读取传感器1（地址 `0x01`）液位寄存器：
- `01 03 00 00 00 01 84 0A`

读取传感器2（地址 `0x02`）液位寄存器：
- `02 03 00 00 00 01 84 39`

## 7. 工程实现建议（针对本项目）
- 周期轮询两个地址，分别得到 `level_upstream` 与 `level_downstream`
- 增加回差阈值，避免继电器在临界值附近抖动
- 增加通信超时与掉线保护（fail-safe：默认开闸或关闸）
- 控制策略建议只驱动一个继电器通道（如 `CH1`）用于水闸执行器

